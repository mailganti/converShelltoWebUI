import sqlite3
from typing import Optional


class OrchestrationDB:

    def __init__(self, conn: sqlite3.Connection):
        self.conn = conn

    def get_user_by_username(self, username: str) -> Optional[dict]:
        """
        Safely fetch a user by username.
        Guards against invalid SQLite parameter binding.
        """

        if not isinstance(username, str):
            return None

        username = username.strip()
        if not username:
            return None

        cursor = self.conn.cursor()
        cursor.execute(
            "SELECT * FROM users WHERE username = ?",
            (username,)
        )

        row = cursor.fetchone()
        if not row:
            return None

        columns = [desc[0] for desc in cursor.description]
        return dict(zip(columns, row))


def get_db() -> OrchestrationDB:
    # existing logic unchanged
    conn = sqlite3.connect("/u01/app/python/ssaAgent/orchestration-system/db/orchestration.db")
    conn.row_factory = None
    return OrchestrationDB(conn)
