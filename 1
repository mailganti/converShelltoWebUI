Traceback (most recent call last):
  File "/u01/app/python/ssaAgent/orchestration-system/controller/deps.py", line 107, in get_runtime_user_from_request
    user = db.get_user_by_username(raw_username)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/u01/app/python/ssaAgent/orchestration-system/controller/db/db.py", line 832, in get_user_by_username
    cursor.execute(
sqlite3.InterfaceError: bad parameter or other API misuse



# -------------------------------------------------------------
# Token-based Authentication
# -------------------------------------------------------------
def verify_token(request: Request) -> Dict[str, Any]:
    """
    Verify authentication - supports both header-based and token-based auth.

    Checks in order:
    1. Proxy headers (X-Auth-User, X-Client-Cert-CN, etc.)
    2. X-Admin-Token header
    3. X-Agent-Token header
    """
    # First try proxy headers (Smart Card / WNA)
    user = get_runtime_user_from_request(request)
    if user and user.get("username"):
        return user

    # Try X-Admin-Token
    admin_token = request.headers.get("X-Admin-Token")
    if admin_token:
        db = get_db()
        token_row = db.get_token_by_value(admin_token)
        if token_row and token_row.get("revoked") != 1:
            return {
                "username": token_row.get("token_name"),
                "token_name": token_row.get("token_name"),
                "role": token_row.get("role"),
                "auth_method": "token",
            }
        raise HTTPException(status_code=401, detail="Invalid or revoked admin token")

    # Try X-Agent-Token
    agent_token = request.headers.get("X-Agent-Token")
    if agent_token:
        db = get_db()
        token_row = db.get_token_by_value(agent_token)
        if token_row and token_row.get("revoked") != 1:
            if token_row.get("role") != "agent":
                raise HTTPException(status_code=403, detail="Token is not an agent token")
            return {
                "username": token_row.get("token_name"),
                "token_name": token_row.get("token_name"),
                "role": "agent",
                "auth_method": "agent_token",
            }
        raise HTTPException(status_code=401, detail="Invalid or revoked agent token")

    raise HTTPException(status_code=401, detail="Authentication required")







SELECT * FROM user_agent_access;

-- 2. See your users
SELECT user_id, username, role FROM users;

-- 3. Grant ALL access (*) to all admins
INSERT OR IGNORE INTO user_agent_access (user_id, environment, granted_by)
SELECT user_id, '*', 'system' FROM users WHERE role = 'admin';

-- 4. Or grant to a specific user (replace USERNAME)
INSERT OR IGNORE INTO user_agent_access (user_id, environment, granted_by)
SELECT user_id, '*', 'system' FROM users WHERE username = 'John Snow';

SELECT u.username, u.role, a.environment 
FROM users u 
LEFT JOIN user_agent_access a ON u.user_id = a.user_id;
















CREATE TABLE IF NOT EXISTS user_agent_access (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    environment VARCHAR(10) NOT NULL,
    granted_by VARCHAR(255),
    granted_at TEXT DEFAULT (datetime('now')),
    UNIQUE(user_id, environment)
);


INSERT OR IGNORE INTO user_agent_access (user_id, environment, granted_by)
SELECT user_id, '*', 'system' FROM users WHERE role = 'admin';



INSERT INTO user_agent_access (user_id, environment, granted_by)
VALUES (USER_ID, '*', 'manual_fix');
sqlite3 orchestration.db

-- List recent sessions
SELECT session_token, user_id, expires_at, created_at 
FROM user_sessions 
ORDER BY created_at DESC LIMIT 5;



SELECT session_token, expires_at, datetime('now') as now_time
FROM user_sessions 
ORDER BY created_at DESC LIMIT 3;

-- Does that user_id actually exist and is active?
SELECT s.session_token, s.user_id, u.username, u.role, u.is_active
FROM user_sessions s
LEFT JOIN users u ON s.user_id = u.user_id
ORDER BY s.created_at DESC LIMIT 5;













-- Verify
SELECT u.username, u.role, uaa.environment 
FROM users u 
JOIN user_agent_access uaa ON u.user_id = uaa.user_id;




SELECT user_id, username, role, created_at 
FROM users 
WHERE LOWER(username) LIKE LOWER('%mudiganti%')
ORDER BY created_at;

-- 2. Pick the ONE user_id you want to keep (probably the oldest/first one)
--    Then update it to have admin role:
UPDATE users SET role = 'admin' WHERE user_id = <YOUR_USER_ID>;

-- 3. Delete the duplicate records (keep the one you updated)
DELETE FROM users 
WHERE LOWER(username) LIKE LOWER('%mudiganti%') 
AND user_id != <YOUR_USER_ID>;

-- 4. Also ensure you have admin in user_roles table
INSERT OR IGNORE INTO user_roles (user_id, role_id, assigned_by)
SELECT <YOUR_USER_ID>, role_id, 'manual_fix'
FROM roles WHERE role_name = 'admin';

-- 5. Clear any stale sessions (optional, forces re-login)
DELETE FROM user_sessions WHERE user_id != <YOUR_USER_ID>;

SELECT u.username, r.role_name, ur.assigned_at 
FROM users u 
LEFT JOIN user_roles ur ON u.user_id = ur.user_id 
LEFT JOIN roles r ON ur.role_id = r.role_id 
WHERE u.username LIKE '%Mudiganti%' OR u.username LIKE '%Raj%';

UPDATE users SET role = 'admin' WHERE username = 'YOUR_USERNAME';

-- Option B: Add admin role to user_roles table
INSERT INTO user_roles (user_id, role_id, assigned_by)
SELECT u.user_id, r.role_id, 'manual_fix'
FROM users u, roles r
WHERE u.username = 'YOUR_USERNAME' AND r.role_name = 'admin';
