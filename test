

@app.get("/debug-headers")
async def debug_headers(request: Request):
    return {
        "client_host": request.client.host if request.client else "unknown",
        "all_headers": dict(request.headers),
    }


@app.get("/debug-headers")
async def debug_headers(request: Request):
    return {
        "client_host": request.client.host,
        "all_headers": dict(request.headers),
        "expected_user_header": AUTH_CONFIG.AUTH_USER_HEADER,
        "expected_method_header": AUTH_CONFIG.AUTH_METHOD_HEADER,
    }


import asyncio
import ssl

async def test():
    # Connect to backend directly
    r, w = await asyncio.open_connection('localhost', 8000)
    
    # Send request
    req = b"GET / HTTP/1.1\r\nHost: localhost:8000\r\nConnection: close\r\n\r\n"
    w.write(req)
    await w.drain()
    
    # Read response
    response = b""
    while True:
        chunk = await r.read(4096)
        if not chunk:
            break
        response += chunk
    
    print(f"Got {len(response)} bytes")
    print(response[:500].decode('utf-8', errors='replace'))
    w.close()

asyncio.run(test())




@app.middleware("http")
async def check_proxy_auth(request: Request, call_next):
    # If proxy already authenticated, set user in state
    proxy_user = request.headers.get("X-Authenticated-User")
    if proxy_user:
        request.state.user = proxy_user
        request.state.authenticated = True
    
    response = await call_next(request)
    return response






async def get_current_user(request: Request) -> Optional[DualAuthUser]:
    """
    Extract authenticated user from proxy headers.
    Returns None if not authenticated (use require_auth for mandatory auth).
    """
    # Get auth headers
    identity = request.headers.get(AUTH_CONFIG.AUTH_USER_HEADER)
    auth_method = request.headers.get(AUTH_CONFIG.AUTH_METHOD_HEADER, "unknown")
    cert_dn = request.headers.get(AUTH_CONFIG.CERT_DN_HEADER)

    if not identity:
        return None

    # Validate trusted proxy
    if not is_trusted_proxy(request):
        logger.warning(f"Auth header from untrusted source: {request.client.host}")
        return None

    # Parse identity
    username, domain = parse_identity(identity)

    if not username:
        return None

    # Build display name
    display_name = None
